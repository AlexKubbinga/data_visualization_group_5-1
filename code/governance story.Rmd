---
title: "Governance Story"
author: "Alex Kubbinga"
date: "11/22/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```



```{r load-packages, echo=FALSE}
library(tidyverse)
library(extrafont)
library(mosaic)
library(vroom)
library(ggtext)
library(gapminder)
library(ggrepel)
library(patchwork)
library(gghighlight)
library(skimr)
library(sf)
library(lubridate)
library(countrycode)

loadfonts(device="pdf")
# loadfonts(device="pdf") if you have a mac
```

```{r esg}


esg_data_raw <- read_csv(here::here("data/ESG_csv","ESGData.csv"))

glimpse(esg_data_raw)
skimr::skim(esg_data_raw)
ncol(esg_data_raw) #67 (col 66 is year 2050 and col 67 is a variable with no information names X67)
#cols 5-65 contain yearly data from 1960-2020
#most indicators have missing data for certainyears. 

#long data 
esg_data <- esg_data_raw %>% pivot_longer(cols=5:65, names_to = "Year") %>% select(-`2050`,-`X67`) %>% janitor::clean_names()


## ALL OF THIS IS NOT SUPER USEFUL FOR ANALYIS (but still look)
# Information on sources of different country series
# esg_countryseries <- read_csv(here::here("data/ESG_csv","ESGCountry-Series.csv"))

#Information on country statistics and methodology
# esg_country <- read_csv(here::here("data/ESG_csv","ESGCountry.csv"))

 #Shows sources of data
# esg_footnote <- read_csv(here::here("data/ESG_csv","ESGFootNote.csv"))

#Explain meaning of different features related to time series
# esg_series_time <- read_csv(here::here("data/ESG_csv","ESGSeries-Time.csv"))
# esg_series <- read_csv(here::here("data/ESG_csv","ESGSeries.csv"))

```   


```{r}



#here we create the wide useable data with each variable as its own column
esg_data_final <- esg_data  %>% select(-indicator_code) %>% group_by(indicator_name) %>% pivot_wider(names_from = indicator_name, values_from = value) %>% janitor::clean_names()

#Writes to data folder
write.csv(esg_data_final, here::here("data","esg_data_final.csv"))

skim(esg_data_final)

esg_data_final$year <- as.integer(esg_data_final$year)


esg_data_final$continent = countrycode(sourcevar = esg_data_final$country_name,origin = "country.name",destination = "continent")

esg_data_final %>% count(continent) %>% mutate(perc = round(100*n/sum(n),2))

esg_data_final %>% count(year) %>% mutate(perc = round(100*n/sum(n),2))


```

# Governance Story

Governance is how well a country/region can sustain its long term stability, growth and poverty reduction given its institutional capacity. It shows the strength of political, financial, legal systems and the capcity to address environmental & social risks. Governance is essentially an indicator of how well positioned a country is to improve (socially, environmentally and economically). How well is the country managed for growth.


```{r}
# install.packages("gganimate")
library(gganimate)

animation_selection <- esg_data_final %>% filter(
                          year >1999)

animation1 <- ggplot(data = animation_selection,
       mapping = aes(x = regulatory_quality_estimate,
                     y = government_effectiveness_estimate,
                     colour = continent,)) +
  geom_point(alpha = 0.5) +
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Year: {frame_time}", 
       x = "Internet Usage", 
       y = "Government Effectiveness Estimate") +    
  transition_time(year)+
  ease_aes("linear")

animate(animation1, height=600, width = 600, duration=20)
```

```{r}
countries_list <- c("China","United Kingdom","India","United States","South Africa", "Spain")

our_data <-esg_data_final %>% filter(country_name %in% countries_list)

```

```{r}
library(GGally)
esg_data_final %>% 
  select(country_name, year,ease_of_doing_business_rank_1_most_business_friendly_regulations,
         government_effectiveness_estimate, regulatory_quality_estimate) %>% #keep Y variable last
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 3,label_round=2, label = TRUE,label_size = 2,hjust = 1)


esg_data_final %>% filter(continent != "NA") %>% ggplot(aes(x=regulatory_quality_estimate, y=government_effectiveness_estimate, color=continent)) +
  geom_point() + labs(
       title = "Almost perfect correlation between Government Effectiveness and Regulatory Quality",
       subtitle = "Scatterplot of yearly values for each country grouped by continent",
       caption = "Source: World Bank ESG Data",
       x= "Regulatory Quality Estimate",
       y = "Government Effectiveness Estimate",
       color="Continent") +
  
  theme(panel.background=element_blank(),
          panel.border=element_blank(),
          plot.background=element_blank()) +
  theme(axis.line = element_line(colour = "black")) +
    theme(text=element_text(size=11, family="Arial")) +
    theme(plot.title.position = "plot") +
    theme(plot.subtitle = element_text( size=11)) +
  geom_text(
    data = data.frame(x = -1, y = 1.5, label = "2019"),
    aes(x = x, y = y, label = "Correlation = 0.93"),
    colour="black",
    family="Arial",
    hjust = 0.5,
    lineheight = .8,
    inherit.aes = FALSE,
  )


```

```{r}
#regulatory quality average
world_avg_reg<- esg_data_final %>% 
  select(country_name, regulatory_quality_estimate, year, continent) %>%
  filter(regulatory_quality_estimate != "NA", continent != "NA") %>%
  group_by(year) %>%
  summarize(world_avg = mean(regulatory_quality_estimate),
            country_name = "World")

world_avg_govteffec<- esg_data_final %>% 
  select(country_name, government_effectiveness_estimate, year, continent) %>%
  filter(government_effectiveness_estimate != "NA", continent != "NA") %>%
  group_by(year) %>%
  summarize(world_avg = mean(government_effectiveness_estimate),
            country_name = "World")


one<-our_data %>% filter(government_effectiveness_estimate != "NA") %>% ggplot(aes(y=government_effectiveness_estimate, x=year, group=country_name, color=country_name)) + 
  geom_smooth(se=FALSE) +
  geom_smooth(data=world_avg_reg, aes(x=year, y=world_avg), linetype = "dashed",color = "gray70") + labs(
       title = "Comparison of Government Effectiveness and Regulatory Quality",
       subtitle = "Lineplots over years for selected countries compared to world average",
       x= "",
       y = "Government Effectiveness Estimate",
       color="Country") +
  theme(panel.background=element_blank(),
          panel.border=element_blank(),
          plot.background=element_blank()) +
  theme(axis.line = element_line(colour = "black")) +
    theme(text=element_text(size=14, family="Arial")) +
    theme(plot.title.position = "plot",
          legend.position = "none") +
    theme(plot.subtitle = element_text( size=11),
           axis.title=element_text(size=12)) +
  scale_y_continuous(breaks=c(0,1,2)) +
   geom_text(
    data = data.frame(x = c(2019,2012,2018.5,2018,2016,2013), y = c(.5,.5,.75,1.15,1.7,1.4), label = c("India","South Africa","China","Spain","United Kingdom","United States")),
    aes(x = x, y = y, label = label),
    colour=c("#D0BC52","#3CD175","#FF6C67","#36D6D9","#8CBDFF","#FF90F1"),
    family="Arial",
    hjust = 0,
    lineheight = .3,
    size = 3,
    inherit.aes = FALSE,
  ) +
    geom_text(
    aes(x = 2018, y = 0, label = "World",fontface=4),
    colour="gray70",
    family="Arial",
    hjust = 0,
    lineheight = .3,
    size = 4,
    inherit.aes = FALSE,
  )





 two<- our_data %>% filter(regulatory_quality_estimate != "NA") %>% ggplot(aes(y=regulatory_quality_estimate, x=year, group=country_name, color=country_name)) + 
  geom_smooth(se=FALSE) + 
   geom_smooth(data=world_avg_reg, aes(x=year, y=world_avg), linetype = "dashed",color = "gray70") +
  labs(
       title = "",
       x= "",
       y = "Regulatory Quality Estimate",
       color="Country") +
  theme(panel.background=element_blank(),
          panel.border=element_blank(),
          plot.background=element_blank()) +
  theme(axis.line = element_line(colour = "black")) +
    theme(text=element_text(size=14, family="Arial")) +
    theme(plot.title.position = "plot",
          legend.position = "none") +
    theme(plot.subtitle = element_text( size=11),
          axis.title=element_text(size=12)) +
   geom_text(
    data = data.frame(x = c(2018.5,2016,2018.5,2018,2017,2016), y = c(-.5,.4,-.4,1,1.8,1.5), label = c("India","South Africa","China","Spain","United Kingdom","United States")),
    aes(x = x, y = y, label = label),
    colour=c("#D0BC52","#3CD175","#FF6C67","#36D6D9","#8CBDFF","#FF90F1"),
    family="Arial",
    hjust = 0,
    lineheight = .3,
    size = 3,
    inherit.aes = FALSE,
  ) +
    geom_text(
    aes(x = 2018, y = 0, label = "World",fontface=4),
    colour="gray70",
    family="Arial",
    hjust = 0,
    lineheight = .3,
    size = 4,
    inherit.aes = FALSE,
  )
   
 
one
two

one/two
#put spain
#change style
#china election and south africa explanation
```



